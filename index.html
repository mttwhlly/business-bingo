<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Bingo</title>
    <link rel="stylesheet" href="https://unpkg.com/98.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jacquard+24&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .title-bar, .window, button, input, label, option, select, table, textarea, ul.tree-view {
            font-size: unset;
        }
        body { 
            background-color: #008080; 
            padding: 20px;
            font-family: 'MS Sans Serif', sans-serif;
            font-size: 16px;
        }
        /* Make the grid responsive */
        .bingo-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
            max-width: 600px;
            margin: 20px auto;
            width: 100%;
            padding: 0 10px;
            max-width: 100vw;
            box-sizing: border-box;
            overflow-x: auto;
        }

        /* Ensure window container is responsive */
        .window {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            box-sizing: border-box;
        }
        .window-body {
            padding: 20px;
            box-sizing: border-box;
        }

        /* Mobile-specific adjustments */
        @media (max-width: 480px) {
            .bingo-grid {
                gap: 3px;
            }
            
            .window {
                margin: 0;
                border-radius: 0;
            }
        }

        /* Prevent horizontal scroll on body */
        body {
            overflow-x: hidden;
            margin: 0;
            padding: 10px;
            box-sizing: border-box;
        }
        
        /* Make cells responsive and fix click blocking issue */
        .bingo-cell {
            aspect-ratio: 1;
            width: 100%;
            padding: 4px;
            font-size: clamp(10px, 2vw, 14px);
            box-sizing: border-box;
            position: relative;
            cursor: pointer;
            border: 1px solid black;
            color: black;
            z-index: 1;
        }

        /* Mobile-specific adjustments */
        @media (max-width: 480px) {
            .bingo-cell {
                font-size: 10px;
                padding: 2px;
                /* Maintain the same fix for mobile */
                position: relative;
                cursor: pointer;
                z-index: 1;
            }
        }

        @media (max-width: 450px) {
            .bingo-grid {
                gap: 2px;
                padding: 0 5px;
                box-sizing: border-box;
            }
            
            .bingo-cell {
                font-size: 9px;
                padding: 1px;
            }
            
            .window {
                margin: 0;
                border-radius: 0;
                padding: 0;
                box-sizing: border-box;
            }
            
            .window-body {
                padding: 5px;
                box-sizing: border-box;
            }
            
            body {
                padding: 5px;
                box-sizing: border-box;
            }
        }

        /* Only show background images for selected cells */
        .bingo-cell.selected {
            color: white;
            text-shadow: 2px 2px 4px black, -2px -2px 4px black, 
                        2px -2px 4px black, -2px 2px 4px black;
            font-weight: bold;
        }

        .bingo-cell.selected::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1; /* Put the background behind the button content */
            pointer-events: none; /* Ensure it doesn't block clicks */
        }

        .bingo-cell.selected span {
            position: relative;
            z-index: 2;
            pointer-events: none; /* Prevent span from interfering with clicks */
        }

        .bingo-cell.free {
            background-color: #008000;
            color: white;
            text-shadow: 1px 1px 2px black;
            cursor: default;
        }
        .hidden { display: none; }
        .notification {
            min-width: 300px;
            box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.3);
        }
        .sunken-panel {
            padding: 0 10px;
            margin-bottom: 20px;
        }
        ol, ul {
            line-height: 2;
            padding-inline-start: 10px;
        }
        .victory-overlay {
            /* Changed to fixed positioning to prevent scrolling */
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-color: rgba(0, 0, 0, 0.8); /* Add dark background */
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .exit-button {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            font-size: 24px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid black;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
        }

        .exit-button:hover {
            background: white;
        }
        .winner-text {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 20px 40px;
            font-family: 'Pixelated MS Sans Serif', sans-serif;
            font-size: 36px;
            font-weight: bold;
            border: 3px solid white;
            text-shadow: 2px 2px 4px black;
        }
        .lobby-hero {
            margin-bottom: 24px;
        }
        .lobby-title {
            font-family: 'Jacquard 24', sans-serif;
            text-align: center;
            margin-bottom: 16px;
            margin-top: 0;
        }
        .lobby-subtitle {
            text-align: center;
            font-size: 18px;
            margin-top: 0;
            margin-bottom: 20px;
        }
        .status-bar {
            margin-top: 8px;
        }
        button:not(.bingo-cell, .exit-button), input[type=email], input[type=number], input[type=password], input[type=text] {
            height: 40px;
            width: 100%;
            padding: 0 10px;
        }
        button#joinRoomBtn {
            margin-top: 0px;
        }
    </style>
</head>
<body>
    <div id="lobby" class="window">
        <div class="title-bar">
            <div class="title-bar-text">Business Bingo - Lobby</div>
        </div>
        <div class="window-body">
            <div class="lobby-hero">
                <h1 class="lobby-title">Business Bingo</h1>
                <h2 class="lobby-subtitle">"Have the best of times during the worst of times"</h2>
                <!-- <div class="sunken-panel"> -->
                    <p>Meeting Agenda:</p>
                    <ul>
                        <li><b>Introduction:</b> Write your name below quickly ...we're timeboxed.</li>
                        <li><b>Follow up:</b> Got an invite? Paste it below and join the room. The team is waiting.</li>
                        <li><b>Action Item:</b> No invite code? Create a room. You're the host.</li>
                    </ul>
            <!-- </div> -->
            <hr />
            </div>
            <div class="field-row-stacked">
                <label for="playerName">Your Name:</label>
                <input type="text" id="playerName" />
            </div>
            <div class="field-row-stacked">
                <button id="createRoomBtn">Create Room</button>
                <div class="field-row">
                    <input type="text" id="roomCode" placeholder="Room code" />
                    <button id="joinRoomBtn">Join Room</button>
                </div>
            </div>
        </div>
        <div class="status-bar">
            <p class="status-bar-field">Press F13 for help</p>
            <p class="status-bar-field">Lobby</p>
            <p class="status-bar-field">CPU Usage: 14%</p>
          </div>
    </div>

    <div id="game" class="window hidden">
        <div class="title-bar">
            <div class="title-bar-text">Business Bingo - Room: <span id="currentRoomCode"></span></div>
        </div>
        <div class="window-body">
            <div id="bingoGrid" class="bingo-grid"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://supabasekong-dcc00k8k4c4g4k08o4gc0cwo.mttwhlly.cc';
        const SUPABASE_KEY = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJzdXBhYmFzZSIsImlhdCI6MTc0NTYwNzY2MCwiZXhwIjo0OTAxMjgxMjYwLCJyb2xlIjoiYW5vbiJ9.79jq6VuCOiKvXnVXxqsu1VzXj8pK9LcHvxi4Y-Xnh_w';
        
        // Initialize Supabase client
        const { createClient } = window.supabase;
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // Game state
        let currentPlayer = null;
        let currentRoom = null;
        let board = [];
        let selectedCells = [];
        
        const defaultPhrases = [
            "Synergy", "Think outside the box",
            "Take it offline", "Bandwidth",
            "Touch base", "Win-win", "Game changer",
            "KPI", "Best practice", "Streamline", 
            "Scalable", "You're on mute", "Double-click",
            "Action items", "ROI", "Stakeholders", "Alignment",
            "Deliverables", "Going forward", "Almost Friday", 
            "Data-driven", "Drill down", "Next steps",
            "On the same page", "Can you send me that?", "Can I share my screen?",
            "How long will that take?", "Leadership",
            "I submitted a ticket", "Call to action", "Need to drop",
            "Line of sight", "In the loop", "Circle back", "AI", "ChatGPT",
        ];
        
        function generateBoard() {
            const shuffled = [...defaultPhrases].sort(() => Math.random() - 0.5);
            const board = [];
            
            for (let i = 0; i < 5; i++) {
                const row = [];
                for (let j = 0; j < 5; j++) {
                    if (i === 2 && j === 2) {
                        row.push('FREE');
                    } else {
                        row.push(shuffled.pop());
                    }
                }
                board.push(row);
            }
            
            return board;
        }
        
        function checkWin(selected) {
            // Check rows
            for (let i = 0; i < 5; i++) {
                if (selected.slice(i * 5, (i + 1) * 5).every(cell => cell)) {
                    return true;
                }
            }
            
            // Check columns
            for (let i = 0; i < 5; i++) {
                if ([0, 1, 2, 3, 4].every(row => selected[row * 5 + i])) {
                    return true;
                }
            }
            
            // Check diagonals
            if ([0, 6, 12, 18, 24].every(index => selected[index]) ||
                [4, 8, 12, 16, 20].every(index => selected[index])) {
                return true;
            }
            
            return false;
        }
        
        async function createRoom() {
            const playerName = document.getElementById('playerName').value;
            if (!playerName) return;
            
            const roomCode = Math.random().toString(36).substring(2, 8).toUpperCase();
            
            const { data: room, error: roomError } = await supabase
                .from('rooms')
                .insert({ code: roomCode, host: playerName })
                .select()
                .single();
                
            if (roomError) {
                console.error('Error creating room:', roomError);
                return;
            }
            
            currentRoom = room;
            await joinRoom(roomCode);
        }
        
        async function joinRoom(roomCode) {
            const playerName = document.getElementById('playerName').value;
            if (!playerName) return;
            
            // First, check if the room exists
            const { data: room, error: roomError } = await supabase
                .from('rooms')
                .select('*')
                .eq('code', roomCode)
                .single();
            
            if (roomError || !room) {
                console.error('Room not found:', roomCode);
                alert('Room not found. Please check the room code.');
                return;
            }
            
            // If room exists, proceed with joining
            board = generateBoard();
            selectedCells = Array(25).fill(false);
            selectedCells[12] = true; // Free space
            
            const { data: player, error: playerError } = await supabase
                .from('players')
                .insert({
                    room_code: roomCode,
                    name: playerName,
                    board: board,
                    selected_cells: selectedCells,
                    has_won: false
                })
                .select()
                .single();
            
            if (playerError) {
                console.error('Error joining room:', playerError);
                alert('Error joining room. Please try again.');
                return;
            }
            
            currentPlayer = player;
            document.getElementById('lobby').classList.add('hidden');
            document.getElementById('game').classList.remove('hidden');
            document.getElementById('currentRoomCode').textContent = roomCode;
            
            renderBoard();
            subscribeToUpdates();
        }
        
        const PEXELS_API_KEY = '3AmSjCSNtLp2aToFNVcEaTqmXQvTpZ1ChtGUnAbHNDsaZ7gWjQuGmK0j';
        let businessImages = [];

        // Fetch business images from Pexels
        async function fetchBusinessImages() {
            try {
                const response = await fetch('https://api.pexels.com/v1/search?query=business+office&per_page=30', {
                    headers: {
                        Authorization: PEXELS_API_KEY
                    }
                });
                
                const data = await response.json();
                businessImages = data.photos.map(photo => photo.src.small);
                console.log('Loaded business images:', businessImages.length);
            } catch (error) {
                console.error('Error fetching Pexels images:', error);
                // Fallback to solid color if API fails
                businessImages = Array(30).fill('');
            }
        }

        // Call this when the app loads
        fetchBusinessImages();

        function renderBoard() {
            const grid = document.getElementById('bingoGrid');
            grid.innerHTML = '';
            
            board.flat().forEach((cell, index) => {
                const cellElement = document.createElement('button');
                cellElement.className = 'bingo-cell';
                cellElement.textContent = cell;
                
                if (selectedCells[index]) {
                    cellElement.classList.add(index === 12 ? 'free' : 'selected');
                    
                    // Only add background image if the cell is selected (and not the free space)
                    if (index !== 12 && businessImages.length > 0) {
                        const imageUrl = businessImages[index % businessImages.length];
                        cellElement.style.backgroundImage = `url('${imageUrl}')`;
                        cellElement.style.backgroundSize = 'cover';
                        cellElement.style.backgroundPosition = 'center';
                    }
                }
                
                if (index !== 12) {
                    cellElement.addEventListener('click', () => selectCell(index));
                }
                
                grid.appendChild(cellElement);
            });
        }
        
        // Add celebration GIFs array
        const celebrationGifs = [
            'https://media.giphy.com/media/l0MYt5jPR6QX5pnqM/giphy.gif', // office celebration
            'https://media.giphy.com/media/Is1O1TWV0LEJi/giphy.gif', // business success
            'https://media.giphy.com/media/5GoVLqeAOo6PK/giphy.gif', // happy office workers
            'https://media.giphy.com/media/l0MYC0LajbaPoEADu/giphy.gif', // cash money
            'https://media.giphy.com/media/LdOyjZ7io5Msw/giphy.gif'  // wolf of wall street
        ];

        async function selectCell(index) {
            if (!currentPlayer || index === 12) return;
            
            selectedCells[index] = !selectedCells[index];
            const hasWon = checkWin(selectedCells);
            
            const { error } = await supabase
                .from('players')
                .update({
                    selected_cells: selectedCells,
                    has_won: hasWon
                })
                .eq('id', currentPlayer.id);
                
            if (error) {
                console.error('Error updating cell:', error);
                return;
            }
            
            renderBoard();
            
            if (hasWon) {
                showVictoryAnimation();
            }
        }

        // Business jargon victory messages in both first and third person
        const victoryMessages = [
            { first: "SYNERGY ACHIEVED!", third: "ACHIEVED SYNERGY!" },
            { first: "MISSION ACCOMPLISHED!", third: "ACCOMPLISHED THEIR MISSION!" },
            { first: "VALUE ADDED!", third: "ADDED VALUE!" },
            { first: "PARADIGM SHIFTED!", third: "SHIFTED THE PARADIGM!" },
            { first: "GAME CHANGED!", third: "CHANGED THE GAME!" },
            { first: "PRODUCTIVITY OPTIMIZED!", third: "OPTIMIZED PRODUCTIVITY!" },
            { first: "DISRUPTION COMPLETE!", third: "COMPLETED THE DISRUPTION!" },
            { first: "SOLUTION DELIVERED!", third: "DELIVERED THE SOLUTION!" },
            { first: "GOALS ALIGNED!", third: "ALIGNED ALL GOALS!" },
            { first: "KPI CRUSHED!", third: "CRUSHED THE KPIS!" },
            { first: "LEVERAGED SUCCESS!", third: "LEVERAGED SUCCESS!" },
            { first: "PROACTIVE WIN!", third: "WON PROACTIVELY!" },
            { first: "THOUGHT LEADER!", third: "BECOME THE THOUGHT LEADER!" },
            { first: "CIRCLE BACK CHAMPION!", third: "BECOME THE CIRCLE BACK CHAMPION!" },
            { first: "BANDWIDTH MAXIMIZED!", third: "MAXIMIZED BANDWIDTH!" },
            { first: "OPTIMIZED FOR SUCCESS!", third: "OPTIMIZED FOR SUCCESS!" },
            { first: "ACTION ITEMS COMPLETED!", third: "COMPLETED THE ACTION ITEMS!" },
            { first: "ENGAGEMENT BOOSTED!", third: "BOOSTED ENGAGEMENT!" },
            { first: "INNOVATION UNLEASHED!", third: "UNLEASHED INNOVATION!" },
        ];

        // Store the current victory message globally for sharing
        let currentVictoryMessage = null;

        // Add this function to return to lobby
        function returnToLobby() {
            // Reset game state
            currentPlayer = null;
            currentRoom = null;
            board = [];
            selectedCells = [];
            
            // Clear input fields
            document.getElementById('playerName').value = '';
            document.getElementById('roomCode').value = '';
            
            // Switch views
            document.getElementById('game').classList.add('hidden');
            document.getElementById('lobby').classList.remove('hidden');
            
            // Clean up any notifications
            const notifications = document.querySelectorAll('.notification');
            notifications.forEach(n => n.remove());
        }

        function showVictoryAnimation() {
            const grid = document.getElementById('bingoGrid');
            
            // Create victory overlay with fixed positioning
            const victoryOverlay = document.createElement('div');
            victoryOverlay.className = 'victory-overlay';
            victoryOverlay.style.position = 'fixed'; // Changed from absolute to fixed
            victoryOverlay.style.top = '0';
            victoryOverlay.style.left = '0';
            victoryOverlay.style.width = '100vw';
            victoryOverlay.style.height = '100vh';
            
            // Add random celebration GIF
            const randomGif = celebrationGifs[Math.floor(Math.random() * celebrationGifs.length)];
            victoryOverlay.style.backgroundImage = `url('${randomGif}')`;
            
            // Get random victory message and store it
            const messageObject = victoryMessages[Math.floor(Math.random() * victoryMessages.length)];
            currentVictoryMessage = messageObject;
            
            // Add first-person winner text for the winner
            const winnerText = document.createElement('div');
            winnerText.className = 'winner-text';
            winnerText.textContent = messageObject.first;
            victoryOverlay.appendChild(winnerText);
            
            // Add exit button
            const exitButton = document.createElement('button');
            exitButton.type = 'button'; // Prevents it from acting as a submit button
            exitButton.className = 'exit-button';
            exitButton.textContent = '×';
            victoryOverlay.appendChild(exitButton);

            exitButton.onclick = (event) => { 
                event.stopPropagation(); // Prevents the click from bubbling up to the overlay
                victoryOverlay.remove();
                returnToLobby();
            };
            
            // Add to body instead of grid to ensure fixed positioning works
            document.body.appendChild(victoryOverlay);
        }

        function showWinnerNotification(winnerName) {
            const notification = document.createElement('div');
            notification.className = 'window notification';
            notification.style.position = 'fixed';
            notification.style.top = '50%';
            notification.style.left = '50%';
            notification.style.transform = 'translate(-50%, -50%)';
            notification.style.zIndex = '1000';
            notification.style.minWidth = '300px';
            notification.style.boxShadow = '5px 5px 10px rgba(0, 0, 0, 0.3)';
            
            // Use the same victory message that the winner sees, but in third person
            const victoryText = currentVictoryMessage ? 
                `${winnerName} has ${currentVictoryMessage.third}` : 
                `Good news is: we have a winner... bad news is: it's ${winnerName}.`;
            
            notification.innerHTML = `
                <div class="title-bar">
                    <div class="title-bar-text">Game Over!</div>
                </div>
                <div class="window-body">
                    <p style="padding: 10px;">${victoryText}</p>
                    <div style="text-align: center; padding: 10px;">
                        <button onclick="this.closest('.notification').remove(); returnToLobby()">OK</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(notification);
        }
        function subscribeToUpdates() {
            supabase
                .channel(`room:${currentPlayer.room_code}`)
                .on('postgres_changes', {
                    event: 'UPDATE',
                    schema: 'public',
                    table: 'players',
                    filter: `room_code=eq.${currentPlayer.room_code}`
                }, payload => {
                    if (payload.new.id === currentPlayer.id) {
                        currentPlayer = payload.new;
                        selectedCells = currentPlayer.selected_cells;
                        renderBoard();
                        
                        if (currentPlayer.has_won) {
                            showVictoryAnimation();
                        }
                    } else if (payload.new.has_won) {
                        // For non-winners, ensure they see the same victory message
                        if (!currentVictoryMessage) {
                            currentVictoryMessage = victoryMessages[Math.floor(Math.random() * victoryMessages.length)];
                        }
                        showWinnerNotification(payload.new.name);
                    }
                })
                .subscribe();
        }
        
        // Event listeners
        document.getElementById('createRoomBtn').addEventListener('click', createRoom);
        document.getElementById('joinRoomBtn').addEventListener('click', () => {
            const roomCode = document.getElementById('roomCode').value.toUpperCase();
            if (roomCode) joinRoom(roomCode);
        });
    </script>
</body>
</html>

